<%- include('../partials/header') %>
<h1><%= title %></h1>
<span>Select one or more image files to upload. 1 classification : 1 image uploaded.</span> <br>
<span class="strike">Select one or more image files to upload. 1 classification : multiple images uploaded.</span>

<form id="addPlantForm" method="POST" enctype="multipart/form-data">
  <div id="dataVisual">
    <div id="imageAndName">
      <fieldset class="form-group">
        <label for="image" class="col-2">Image:</label>
        <input type="file" name="images" id="image" class="form-control" accept=".jpg, .jpeg, .png" required multiple onchange="identifyPlant()">
      </fieldset>
      <div id="nameRow">
        <fieldset class="form-group">
          <label for="name" class="col-2">Name:</label>
          <input name="name" id="name" class="form-control" required readonly/>
        </fieldset>
        <fieldset class="form-group">
          <label for="binomialNomenclature" class="col-2">Scientific Name:</label>
          <input name="binomialNomenclature" id="binomialNomenclature" class="form-control" required readonly/>
        </fieldset>
      </div>
      <div id="top4"></div>
    </div>
    <div id="imageVisual">
      <img src="/site_images/noimage.png" alt="No image" id="preview">
    </div>
  </div>
  
  <!-- This will process multiple images with embedded gps and date data; 
   but may need to process metadata on client side for users that do not have photos with gps or time -->
   <!--
  <fieldset class="form-group">
    <label for="updateDate">Date Identified:</label>
    <input name="updateDate" id="updateDate" required class="form-control" placeholder="YYYY:MM:DD HH:mm:ss"/>
  </fieldset>
  <fieldset class="form-group">
    <label for="location">Location:</label>
    <input name="location" id="location" class="form-control" placeholder="Latitude, Longitude (e.g., 45.0000, -45.0000)" required/>
  </fieldset>
  -->
  
  <!-- Display the selected location's coordinates -->
  <div id="coordinates"><span id="help">If unsure of coordinates - enter name of location, then copy map coordinates</span></div>
  <!-- Display the selected location's coordinates using Leaflet -->
  <div id="map" style="height: 300px;"></div>

  <!-- Button needs to be inside <form> element to trigger POST -->
  <button class="offset-3 btn btn-primary">Save</button>
</form>

<script defer>
  async function identifyPlant() {
    const images = document.getElementById('image').files; // Get the files from the input
    const formData = new FormData();

    // Check if at least one image is selected
    if (images.length === 0) {
      console.error('No images selected');
      return;
    }

    // Append each image to FormData
    for (const image of images) {
      formData.append('images[]', image); // Use 'images[]' to match backend expectations
    }

    try {
      const apiUrl = 'http://localhost:3000/identifyP'; // Your server URL
      const response = await fetch(apiUrl, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        console.error('Error response status:', response.status);
        console.log('Error response text:', await response.text());
        return;
      }

      const data = await response.json();
      console.log('status', response.status);
      console.log('data', data);
      
      // Display top 4 matches for each image
      const top4Div = document.getElementById('top4');
      top4Div.innerHTML = ''; // Clear previous content

      data.top4Matches.forEach((matches, imgIndex) => {
        const imgHeader = document.createElement('h4');
        imgHeader.textContent = `Matches for Image ${imgIndex + 1}:`;
        top4Div.appendChild(imgHeader);

        matches.forEach((match, index) => {
          const matchDiv = document.createElement('div');
          matchDiv.innerHTML = `
            <strong>${index + 1}. Name:</strong> ${match.name}; 
            <strong>Scientific Name:</strong> ${match.scientificName}; 
            <strong>Score:</strong> ${match.score}
          `;
          
          // Create button for each match
          const button = document.createElement('button');
          button.textContent = 'Select';
          button.type = 'button'; // Prevent form submission
          button.onclick = () => {
            document.getElementById('name').value = match.name;
            document.getElementById('binomialNomenclature').value = match.scientificName;
          };

          matchDiv.appendChild(button);
          top4Div.appendChild(matchDiv);  
        });
      });

      // Optionally set initial values for fields from the first image's first match
      if (data.top4Matches.length > 0 && data.top4Matches[0].length > 0) {
        const firstMatch = data.top4Matches[0][0]; // Get the first match of the first image
        document.getElementById('binomialNomenclature').value = firstMatch.scientificName;
        document.getElementById('name').value = firstMatch.name;
      }

      // Sanitize data - keep this to avoid user manipulation in browser console
      document.getElementById('addPlantForm').addEventListener('submit', function(event) {
        const commonNameInput = document.getElementById('name');
        const scientificInput = document.getElementById('binomialNomenclature');

        commonNameInput.value = commonNameInput.value.replace(/[()]/g, '').trim();
        scientificInput.value = scientificInput.value.replace(/[()]/g, '').trim();
      });

    } catch (error) {
      console.error('error', error);
    }
  }
</script>


<%- include('../partials/footer') %>
